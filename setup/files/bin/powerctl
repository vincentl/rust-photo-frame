#!/usr/bin/env bash
set -euo pipefail
MODE="${1:-}"
OUT="${2:-@AUTO@}"
if [[ -z "$MODE" ]]; then
  echo "usage: powerctl {sleep|wake} [OUTPUT]" >&2
  exit 2
fi
detect_out() {
  wlr-randr | awk '
    function commit() {
      if (current == "") {
        return
      }

      if (status_seen) {
        connected = status_connected
      } else if (enabled_seen) {
        connected = enabled
      } else {
        connected = 0
      }

      if (!connected || internal) {
        return
      }

      if (best == "") {
        best = current
      }
    }

    /^[[:space:]]*$/ {
      next
    }

    /^[^[:space:]]/ {
      commit()
      current = $1
      internal = ($1 ~ /^(eDP|LVDS)/)
      enabled = 0
      enabled_seen = 0
      status_connected = 0
      status_seen = 0
      next
    }

    /^[[:space:]]+Enabled:[[:space:]]*/ {
      value = tolower($2)
      if (value == "yes" || value == "on" || value == "true" || value == "1") {
        enabled = 1
        enabled_seen = 1
      } else if (value == "no" || value == "off" || value == "false" || value == "0") {
        enabled = 0
        enabled_seen = 1
      }
      next
    }

    /^[[:space:]]+Status:[[:space:]]*/ {
      status_seen = 1
      if (tolower($2) ~ /^connected/) {
        status_connected = 1
      } else if (tolower($2) ~ /^disconnected/) {
        status_connected = 0
      }
      next
    }

    END {
      commit()
      if (best != "") {
        print best
        exit 0
      }
      exit 1
    }
  '
}
if [[ "$OUT" == "@AUTO@" ]]; then
  if ! OUT="$(detect_out)"; then
    echo "powerctl: failed to detect connected output" >&2
    exit 1
  fi
fi
if [[ "$MODE" == "sleep" ]]; then
  wlr-randr --output "$OUT" --off || vcgencmd display_power 0
else
  wlr-randr --output "$OUT" --on  || vcgencmd display_power 1
fi
