#!/usr/bin/env bash
set -euo pipefail

MODE="${1:-}"
TARGET="${2:-*}"
if [[ "$MODE" != "sleep" && "$MODE" != "wake" ]]; then
  echo "usage: powerctl {sleep|wake} [OUTPUT]" >&2
  exit 2
fi

runtime_dir="${XDG_RUNTIME_DIR:-}"
if [[ -z "$runtime_dir" ]]; then
  runtime_dir="/run/user/$(id -u)"
fi

if [[ ! -d "$runtime_dir" ]]; then
  echo "powerctl: XDG_RUNTIME_DIR '$runtime_dir' does not exist" >&2
  exit 1
fi

find_sway_socket() {
  local socket="${SWAYSOCK:-}"
  if [[ -n "$socket" && -S "$socket" ]]; then
    printf '%s' "$socket"
    return 0
  fi

  local matches
  if ! matches=$(compgen -G "${runtime_dir%/}/sway-ipc.*.sock" 2>/dev/null); then
    return 1
  fi

  local candidate
  while IFS= read -r candidate; do
    if [[ -S "$candidate" ]]; then
      printf '%s' "$candidate"
      return 0
    fi
  done <<<"$matches"

  return 1
}

socket="$(find_sway_socket)" || {
  echo "powerctl: failed to locate sway IPC socket in $runtime_dir" >&2
  exit 1
}

export XDG_RUNTIME_DIR="$runtime_dir"
export SWAYSOCK="$socket"

if [[ "$MODE" == "sleep" ]]; then
  swaymsg output "$TARGET" power off
else
  swaymsg output "$TARGET" power on
fi
